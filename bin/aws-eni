#!/usr/bin/env ruby

require 'aws-eni'

eni = Aws::ENI.new

begin
  case ARGV[0]

  # list command
  when 'list'
    eni.list(ARGV[1]).each do |interface|
      puts "#{interface[:name]}:\tID #{interface[:interface_id]}  HWaddr #{interface[:hwaddr]}"
      interface[:ip_assoc].each do |local_ip, public_ip|
        if public_ip
          puts "\t#{local_ip} => #{public_ip}"
        else
          puts "\t#{local_ip}"
        end
      end
    end

  # sync command
  when 'sync'
    if eni.sync != 0
      puts 'synchronized interface config'
    else
      puts 'network interface config already in sync'
    end

  # add command
  when 'add'
    @add = eni.add(ARGV[1], ARGV[2])
    puts "added #{@add['device']} with private ip #{@add['private_ip']}"

  # remove command
  when 'remove'
    @remove = eni.remove(ARGV[1], ARGV[2], ARGV[3])
    if @remove['release'] == true
      puts "removed #{@remove['private_ip']} and dissociated #{remove['public_ip']} from #{@remove['device']}"
    else
      puts "removed #{@remove['private_ip']} from #{@remove['device']}"
    end

  # assoc command
  when 'associate'
    @assoc = eni.assoc(ARGV[1], ARGV[2])
    puts "associated #{@assoc['private_ip']} => #{@assoc['public_ip']}"

  else
    abort "Unknown command: #{ARGV[0]}"
  end


# handle library exceptions
rescue Aws::ENI::Error => e
  abort "Error: " + e.message
end
